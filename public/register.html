<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Register — BlockCerts Demo</title>
  <link rel="stylesheet" href="style2.css">
</head>
<body>
  <header class="container">
    <div class="nav">
      <div class="brand">
        <div class="logo"DLT</div>
        <div class="brand-text">
          <div class="brand-title">DLT</div>
          <div class="brand-sub">Secured Powered Application To Promote Property Integrity</div>
        </div>
        <ul class="nav-list">
          <a href="index.html">Home</a>
        </ul>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="form-section">
      <h1 class="form-title">Register</h1>
      <p class="form-sub">Enter The Property Id Or Document Id.</p>

      <form class="card form-card">
        <input type="text" class="input" id="certificateCode" placeholder="Enter Doc Or Property Id" required />
        <button type="button" id="mintBtn" class="btn primary">Register</button>
      </form>
      <p id="status"></p>
    </section>
  </main>

  <footer class="container footer">
    <div class="footer-inner">
      <div>
        <strong>DLT</strong>
        <div class="muted">Secure Software · For Properties</div>
      </div>
      <div class="muted">© 2025 Mukiibi Micheal Kirinnya & Ian Asasira Tusiime</div>
    </div>
  </footer>

  <script src="libs/ethers.umd.min.js"></script>

  <!--<script>
    const contractAddress = "0xA9D364a0f83cfAff2Cd86368E06ef68c5d7A891a"; // deployed contract
    const abi = [
      {
        "inputs":[{"internalType":"bytes32","name":"certificateHash","type":"bytes32"}],
        "name":"mintCertificate",
        "outputs":[],
        "stateMutability":"nonpayable",
        "type":"function"
      },
      {
        "inputs":[{"internalType":"bytes32","name":"certificateHash","type":"bytes32"}],
        "name":"verifyCertificate",
        "outputs":[{"internalType":"bool","name":"","type":"bool"},{"internalType":"uint256","name":"","type":"uint256"}],
        "stateMutability":"view",
        "type":"function"
      }
    ];

    const mintBtn = document.getElementById("mintBtn");
    const statusEl = document.getElementById("status");

    async function connectWallet() {
      if (window.ethereum) {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        return new ethers.providers.Web3Provider(window.ethereum).getSigner();
      } else {
        alert("MetaMask is required to register certificates");
        return null;
      }
    }

    mintBtn.addEventListener("click", async () => {
      const code = document.getElementById("certificateCode").value.trim();
      if (!code) {
        alert("Enter a certificate code");
        return;
      }

      const signer = await connectWallet();
      if (!signer) return;

      const contract = new ethers.Contract(contractAddress, abi, signer);
      const hash = ethers.utils.id(code);

      try {
        mintBtn.disabled = true; // prevent double clicks
        statusEl.textContent = "⏳ Checking certificate...";

        // Step 1: Check if certificate exists
        const [exists] = await contract.verifyCertificate(hash);
        if (exists) {
          statusEl.textContent = "⚠️ Certificate already registered!";
          mintBtn.disabled = false;
          return;
        }

        // Step 2: Send mint transaction
        statusEl.textContent = "⏳ Sending transaction...";
        const tx = await contract.mintCertificate(hash);
        await tx.wait();
        statusEl.textContent = `✅ Certificate registered! Hash: ${hash}`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ Error registering certificate. Check network or MetaMask.";
      } finally {
        mintBtn.disabled = false;
      }
    });
  </script>
-->
<script>

const contractAddress = "0xdB0329Ffe02e9b60ec9d8Da41ca291de0F943E15"; // deployed contract
const abi = [
  {
    "inputs":[{"internalType":"bytes32","name":"certificateHash","type":"bytes32"}],
    "name":"mintCertificate",
    "outputs":[],
    "stateMutability":"nonpayable",
    "type":"function"
  },
  {
    "inputs":[{"internalType":"bytes32","name":"certificateHash","type":"bytes32"}],
    "name":"verifyCertificate",
    "outputs":[{"internalType":"bool","name":"","type":"bool"},{"internalType":"uint256","name":"","type":"uint256"}],
    "stateMutability":"view",
    "type":"function"
  }
];

const mintBtn = document.getElementById("mintBtn");
const statusEl = document.getElementById("status");

async function connectWallet() {
  if (window.ethereum) {
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    return new ethers.providers.Web3Provider(window.ethereum).getSigner();
  } else {
    alert("MetaMask is required to register certificates");
    return null;
  }
}

mintBtn.addEventListener("click", async () => {
  const code = document.getElementById("certificateCode").value.trim();
  if (!code) { alert("Enter a certificate code"); return; }

  const signer = await connectWallet();
  if (!signer) return;

  const contract = new ethers.Contract(contractAddress, abi, signer);
  const hash = ethers.utils.id(code);

  try {
    mintBtn.disabled = true;
    statusEl.textContent = "⏳ Checking certificate...";

    const [exists] = await contract.verifyCertificate(hash);
    if (exists) {
      statusEl.innerHTML = "⚠️ Certificate already registered!";
      mintBtn.disabled = false;
      return;
    }

    statusEl.textContent = "⏳ Sending transaction...";
    const tx = await contract.mintCertificate(hash);
    await tx.wait();

    // Show both the certificate hash and Etherscan link
    statusEl.innerHTML = `
      ✅ Certificate registered!<br>
      Certificate hash: <code>${hash}</code><br>
      Transaction: <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank">View on Etherscan</a>
    `;
  } catch (err) {
    console.error(err);
    statusEl.textContent = "❌ Error registering certificate. Check network or MetaMask.";
  } finally {
    mintBtn.disabled = false;
  }
});

</script>
</body>
</html>
